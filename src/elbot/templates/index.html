{% extends "base.html" %}
{% block title %}Elbot Portal{% endblock %}
{% block content %}
<h2>Operations</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flash">
    {% for category, message in messages %}
      <li class="{{ category }}">{{ message|safe }}</li>
    {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
<div class="grid">
  <form method="post" action="{{ url_for('update') }}" class="card">
    <h3>Update Bot</h3>
    <p>Runs <code>elbotctl update</code> to pull the latest code and dependencies.</p>
    <button type="submit">Run Update</button>
  </form>
  <form method="post" action="{{ url_for('toggle_auto_update') }}" class="card">
    <h3>Auto Update Scheduler</h3>
    {% if auto_update_status.mode == 'systemd' %}
      {% set details = auto_update_status.details %}
      {% if details and details.enabled %}
        <p>Systemd timer is enabled{% if details.next_run %}; next run {{ details.next_run }}{% endif %}.</p>
        <button type="submit" name="action" value="disable">Disable Timer</button>
      {% else %}
        <p>Systemd detected. Enable to run daily updates at 03:00.</p>
        <button type="submit" name="action" value="enable">Enable Timer</button>
      {% endif %}
      {% if details and details.last_trigger %}
        <p class="note">Last run: {{ details.last_trigger }}</p>
      {% endif %}
    {% elif auto_update_status.mode == 'cron' %}
      {% if auto_update_status.cron_enabled %}
        <p>Cron job installed (runs daily at 03:00).</p>
        <button type="submit" name="action" value="disable">Remove Cron Job</button>
      {% else %}
        <p>Cron detected. Enable to install a daily 03:00 update job.</p>
        <button type="submit" name="action" value="enable">Install Cron Job</button>
      {% endif %}
    {% else %}
      <p>No scheduler available. Configure manually or set <code>AUTO_UPDATE=1</code> before starting the portal.</p>
    {% endif %}
    {% if legacy_auto_update %}
      <p class="note">Legacy in-app auto-update thread is active.</p>
    {% endif %}
  </form>
  <form method="post" action="{{ url_for('service_action', action='restart') }}" class="card">
    <h3>Restart Service</h3>
    <p>Requires the systemd service to be installed. You may need sudo.</p>
    <button type="submit">Restart</button>
  </form>
  <form method="post" action="{{ url_for('service_action', action='status') }}" class="card">
    <h3>Service Status</h3>
    <button type="submit">Check Status</button>
  </form>
  <form method="post" action="{{ url_for('validate_lavalink') }}" class="card">
    <h3>Validate Lavalink</h3>
    <p>Runs <code>elbotctl check</code> to confirm Lavalink connectivity.</p>
    <button type="submit">Run Validation</button>
  </form>
  <form method="post" action="{{ url_for('service_action', action='start') }}" class="card">
    <h3>Start Service</h3>
    <button type="submit">Start</button>
  </form>
  <form method="post" action="{{ url_for('service_action', action='stop') }}" class="card">
    <h3>Stop Service</h3>
    <button type="submit">Stop</button>
  </form>
</div>

<h2>Tools</h2>
<ul class="links">
  <li><a href="{{ url_for('settings') }}">Environment Settings</a></li>
  <li><a href="{{ url_for('view_logs') }}">View Logs</a></li>
  <li><a href="{{ url_for('branch') }}">Switch Git Branch</a></li>
  <li><a href="{{ url_for("update_status") }}">Check update status</a></li>
</ul>
<p class="note">Need to run commands manually? Use <code>elbotctl ...</code>, or if the shell cannot find it, <code>.venv/bin/elbotctl ...</code> / <code>python -m elbot.cli ...</code>.</p>
{% endblock %}
