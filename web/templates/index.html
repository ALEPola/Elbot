<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELBOT Control Center</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='futuristic.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="neon">

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand futuristic-heading fs-4">ELBOT</span>
    <button class="btn btn-sm btn-neon" id="themeToggle">Toggle Theme</button>
  </nav>

  <!-- Navigation Links -->
  <div class="container-xl my-2">
    <div class="row g-4 justify-content-center">
      <div class="col-xxl-10">
        <div class="d-flex justify-content-center">
          <a href="/status" class="btn btn-neon btn-neon-primary mx-2">Bot Status</a>
          <a href="/logs" class="btn btn-neon btn-neon-primary mx-2">Logs</a>
          <a href="/commands" class="btn btn-neon btn-neon-primary mx-2">Command Management</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed‑width grid container -->
  <div class="container-xl my-4">
    <div class="row g-4 justify-content-center">

      <!-- Status + Controls -->
      <div class="col-xxl-10">
        <div class="control-card text-center">
          <div class="d-flex align-items-center mb-3">
            <span id="botStatus" class="status-badge bg-success text-white me-3">Status: --</span>
            <span id="lastUpdate" class="text-muted me-auto">Last Update: --</span>
            <a href="/logout" class="btn btn-neon btn-neon-danger btn-sm">Logout</a>
          </div>
          <div class="row g-3">
            <div class="col-md-3"><a href="/action/start"   class="btn btn-neon btn-neon-primary w-100 fw-bold">Start</a></div>
            <div class="col-md-3"><a href="/action/stop"    class="btn btn-neon btn-neon-danger  w-100 fw-bold">Stop</a></div>
            <div class="col-md-3"><a href="/action/restart" class="btn btn-neon btn-neon-warning w-100 fw-bold">Restart</a></div>
            <div class="col-md-3"><a href="/action/update"  class="btn btn-neon btn-neon-primary w-100 fw-bold">Update</a></div>
          </div>
        </div>
      </div>

      <!-- System chart -->
      <div class="col-xxl-10">
        <div class="control-card">
          <h5 class="section-header">System Usage</h5>
          <canvas id="cpuChart" height="100"></canvas>
        </div>
      </div>

      <!-- Logs -->
      <div class="col-xxl-10">
        <div class="control-card">
          <h5 class="section-header">Logs</h5>
          <pre id="logOutput" class="log-box" style="height:280px;">Connecting …</pre>
        </div>
      </div>

      <!-- Command Runner -->
      <div class="col-xl-6 col-xxl-5">
        <div class="control-card">
          <h5 class="section-header">Command Runner</h5>
          <form id="commandForm">
            <input class="form-control mb-2" id="commandInput" placeholder="Enter shell command…">
            <button class="btn btn-neon btn-neon-primary w-100">Run</button>
          </form>
          <pre id="commandOutput" class="log-box mt-3">Waiting for input…</pre>
        </div>
      </div>

      <!-- Git Branch -->
      <div class="col-xl-6 col-xxl-5">
        <div class="control-card">
          <h5 class="section-header">Git Branch</h5>
          <form id="branchForm" class="row g-2">
            <div class="col-8"><select id="branchSelect" class="form-select"></select></div>
            <div class="col-4"><button class="btn btn-neon btn-neon-primary w-100">Switch</button></div>
          </form>
          <pre id="branchOutput" class="log-box mt-3">Current branch: --</pre>
        </div>
      </div>

      <!-- Environment -->
      <div class="col-xl-6 col-xxl-5">
        <div class="control-card">
          <h5 class="section-header">Environment Variables</h5>
          <pre id="envOutput" class="log-box">Loading…</pre>
        </div>
      </div>

      <!-- Scheduler -->
      <div class="col-xl-6 col-xxl-5">
        <div class="control-card">
          <h5 class="section-header">Auto‑Restart Scheduler</h5>
          <form id="scheduleForm" class="row g-2">
            <div class="col-8"><input id="scheduleTime" class="form-control" placeholder="HH MM (e.g., 3 0)"></div>
            <div class="col-4"><button class="btn btn-neon btn-neon-primary w-100">Set</button></div>
          </form>
          <pre id="scheduleOutput" class="log-box mt-3">Awaiting input…</pre>
        </div>
      </div>

      <!-- Last Update -->
      <div class="col-xxl-10">
        <div class="last-update">
          <p>Last Update: <span id="last-update">Fetching...</span></p>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast zone -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastZone"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  /* ---- THEME ---- */
  const savedTheme = localStorage.getItem('theme') || 'neon';
  document.body.dataset.theme = savedTheme;
  document.getElementById('themeToggle').onclick = () => {
    const t = document.body.dataset.theme === 'neon' ? 'dark' : 'neon';
    document.body.dataset.theme = t; localStorage.setItem('theme', t);
  };

  /* ---- WEBSOCKET LOGS ---- */
  const logBox = document.getElementById('logOutput');
  const ws = new WebSocket(`ws://${location.host}/ws/logs`);
  ws.onmessage = e => { logBox.textContent += e.data + "\\n"; logBox.scrollTop = logBox.scrollHeight; };
  ws.onerror   = () => logBox.textContent += '\\n[log stream error]';

  /* ---- CHART ---- */
  const ctx = document.getElementById('cpuChart');
  const chart = new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:'CPU %',data:[],borderColor:'var(--accent)',tension:.3}]},
    options:{responsive:true,animation:false,scales:{y:{min:0,max:100}}}
  });
  setInterval(async()=>{
    const res=await fetch('/api/system'); if(!res.ok) return;
    const {cpu}=await res.json();
    const t=new Date().toLocaleTimeString();
    chart.data.labels.push(t); chart.data.datasets[0].data.push(cpu);
    if(chart.data.labels.length>60){chart.data.labels.shift();chart.data.datasets[0].data.shift();}
    chart.update();
  },3000);

  /* ---- STATUS BADGE ---- */
  fetch('/api/status').then(r=>r.json()).then(j=>{
    const b=document.getElementById('botStatus');
    b.textContent='Status: '+j.status;
    b.className='status-badge '+(j.status==='Running'?'bg-success':'bg-danger')+' text-white';
  });

  /* ---- COMMAND RUNNER ---- */
  document.getElementById('commandForm').addEventListener('submit',e=>{
    e.preventDefault();
    const cmd=document.getElementById('commandInput').value.trim();
    if(!cmd) return;
    fetch('/run-command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})})
      .then(r=>r.json()).then(j=>document.getElementById('commandOutput').textContent=j.output);
  });

  /* ---- BRANCH LIST & SWITCH ---- */
  fetch('/api/branches').then(r=>r.json()).then(j=>{
    const sel=document.getElementById('branchSelect'); sel.innerHTML='';
    j.branches.forEach(b=>sel.insertAdjacentHTML('beforeend',`<option>${b}</option>`));
  });
  document.getElementById('branchForm').addEventListener('submit',e=>{
    e.preventDefault();
    const branch=document.getElementById('branchSelect').value;
    fetch('/switch-branch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({branch})})
      .then(r=>r.json()).then(j=>{
        document.getElementById('branchOutput').textContent=j.error||j.output;
      });
  });

  /* ---- ENV VARS ---- */
  fetch('/api/env').then(r=>r.json()).then(j=>{
    document.getElementById('envOutput').textContent =
      Object.entries(j).map(([k,v])=>`${k}: ${v}`).join('\\n');
  });

  /* ---- SCHEDULER ---- */
  document.getElementById('scheduleForm').addEventListener('submit',e=>{
    e.preventDefault();
    const t=document.getElementById('scheduleTime').value.trim();
    if(!t) return;
    fetch(`/action/schedule:${t}`).then(()=>{
      document.getElementById('scheduleOutput').textContent=`Restart scheduled for ${t}`;
    });
  });

  /* ---- LAST UPDATE ---- */
  fetch('/api/status')
      .then(response => response.json())
      .then(data => {
          document.getElementById('last-update').textContent = new Date().toLocaleString();
      })
      .catch(error => console.error('Error fetching last update:', error));
</script>

<style>
    .last-update {
        margin-top: 20px;
        font-size: 14px;
        color: #555;
    }
</style>
</body>
</html>
