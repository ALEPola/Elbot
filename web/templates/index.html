<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELBOT Control Center</title>

  <!-- Bootstrap + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='futuristic.css') }}"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="neon">
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand futuristic-heading">ELBOT</span>
    <button class="btn btn-sm btn-neon" id="themeToggle">Toggle Theme</button>
  </nav>

  <div class="container py-3">
    <!-- Status row -->
    <div class="d-flex align-items-center mb-3">
      <span id="botStatus" class="status-badge bg-success text-white me-3">Status: --</span>
      <span id="lastUpdate" class="text-muted me-auto">Last Update: --</span>
      <a href="/logout" class="btn btn-neon btn-neon-danger">Logout</a>
    </div>

    <!-- Control buttons -->
    <div class="control-card p-3 mb-4">
      <div class="row g-3 text-center">
        <div class="col-md-3"><a href="/action/start"   class="btn btn-neon btn-neon-primary w-100">Start</a></div>
        <div class="col-md-3"><a href="/action/stop"    class="btn btn-neon btn-neon-danger w-100">Stop</a></div>
        <div class="col-md-3"><a href="/action/restart" class="btn btn-neon btn-neon-warning w-100">Restart</a></div>
        <div class="col-md-3"><a href="/action/update"  class="btn btn-neon btn-neon-primary w-100">Update</a></div>
      </div>
    </div>

    <!-- Live system chart -->
    <div class="control-card p-3 mb-4">
      <h5 class="section-header">System Usage</h5>
      <canvas id="cpuChart" height="100"></canvas>
    </div>

    <!-- Live logs -->
    <div class="control-card p-3 mb-4">
      <h5 class="section-header">Logs</h5>
      <pre class="log-box" id="logOutput" style="height:300px; overflow:auto;">Connecting …</pre>
    </div>

    <!-- Command Runner -->
    <div class="section-header">Command Runner</div>
    <div class="control-card p-3 mb-4">
      <form id="commandForm">
        <div class="mb-3">
          <input type="text" class="form-control" id="commandInput" placeholder="Enter shell command…"/>
        </div>
        <button type="submit" class="btn btn-neon btn-neon-primary">Run Command</button>
      </form>
      <pre class="mt-3 log-box" id="commandOutput">Waiting for input…</pre>
    </div>

    <!-- Git Branch Switcher -->
    <div class="section-header">Git Branch</div>
    <div class="control-card p-3 mb-4">
      <form id="branchForm">
        <div class="row g-2">
          <div class="col-md-8"><select class="form-select" id="branchSelect"></select></div>
          <div class="col-md-4"><button type="submit" class="btn btn-neon btn-neon-primary w-100">Switch Branch</button></div>
        </div>
      </form>
      <pre class="mt-3 log-box" id="branchOutput">Current branch: --</pre>
    </div>

    <!-- Environment Variables -->
    <div class="section-header">Environment Variables</div>
    <div class="control-card p-3 mb-4">
      <pre class="log-box" id="envOutput">Loading…</pre>
    </div>

    <!-- Auto‑Restart Scheduler -->
    <div class="section-header">Auto‑Restart Scheduler</div>
    <div class="control-card p-3 mb-4">
      <form id="scheduleForm">
        <div class="row g-2">
          <div class="col-md-5">
            <input type="text" id="scheduleTime" class="form-control" placeholder="HH MM (e.g., 3 0)"/>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-neon btn-neon-primary w-100">Set Restart Time</button>
          </div>
        </div>
      </form>
      <pre class="mt-3 log-box" id="scheduleOutput">Awaiting input…</pre>
    </div>
  </div>

<!-- Scripts -->
<script>
  /* Theme toggle */
  const savedTheme = localStorage.getItem('theme') || 'neon';
  document.body.dataset.theme = savedTheme;
  document.getElementById('themeToggle').onclick = () => {
      const t = document.body.dataset.theme === 'neon' ? 'dark' : 'neon';
      document.body.dataset.theme = t;
      localStorage.setItem('theme', t);
  };

  /* WebSocket log stream */
  const logBox = document.getElementById('logOutput');
  const ws = new WebSocket(`ws://${location.host}/ws/logs`);
  ws.onmessage = e => { logBox.textContent += e.data + "\\n"; logBox.scrollTop = logBox.scrollHeight; };
  ws.onerror = () => logBox.textContent += '\\n[log stream error]';

  /* Chart.js live CPU */
  const ctx = document.getElementById('cpuChart');
  const cpuChart = new Chart(ctx,{
      type:'line',
      data:{labels:[],datasets:[{label:'CPU %',data:[],borderColor:'#39FF14',tension:0.3}]},
      options:{responsive:true,animation:false,scales:{y:{min:0,max:100}}}
  });
  setInterval(async()=>{
      const r = await fetch('/api/system'); if(!r.ok) return;
      const {cpu} = await r.json();
      const t = new Date().toLocaleTimeString();
      cpuChart.data.labels.push(t);
      cpuChart.data.datasets[0].data.push(cpu);
      if(cpuChart.data.labels.length>60){
        cpuChart.data.labels.shift();
        cpuChart.data.datasets[0].data.shift();
      }
      cpuChart.update();
  },3000);

  /* Initial bot status */
  fetch('/api/status')
    .then(r=>r.json())
    .then(j=>{
      const badge=document.getElementById('botStatus');
      badge.textContent='Status: '+j.status;
      badge.className='status-badge '+(j.status==='Running'?'bg-success':'bg-danger')+' text-white';
    });

  /* Command runner */
  document.getElementById('commandForm').addEventListener('submit',e=>{
      e.preventDefault();
      const cmd=document.getElementById('commandInput').value.trim();
      if(!cmd) return;
      fetch('/run-command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})})
      .then(r=>r.json()).then(j=>{
        document.getElementById('commandOutput').textContent=j.output;
      });
  });

  /* Load branches */
  fetch('/api/branches').then(r=>r.json()).then(j=>{
      const sel=document.getElementById('branchSelect');
      sel.innerHTML="";
      j.branches.forEach(b=>sel.insertAdjacentHTML('beforeend',`<option>${b}</option>`));
  });
  /* Branch switch */
  document.getElementById('branchForm').addEventListener('submit',e=>{
      e.preventDefault();
      const branch=document.getElementById('branchSelect').value;
      fetch('/switch-branch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({branch})})
      .then(r=>r.json()).then(j=>{
        document.getElementById('branchOutput').textContent=j.error||j.output;
      });
  });

  /* Environment variables */
  fetch('/api/env').then(r=>r.json()).then(j=>{
      const txt=Object.entries(j).map(([k,v])=>`${k}: ${v}`).join('\\n');
      document.getElementById('envOutput').textContent=txt;
  });

  /* Scheduler */
  document.getElementById('scheduleForm').addEventListener('submit',e=>{
      e.preventDefault();
      const t=document.getElementById('scheduleTime').value.trim();
      if(!t) return;
      fetch(`/action/schedule:${t}`).then(()=>{
        document.getElementById('scheduleOutput').textContent=`Restart scheduled for ${t}`;
      });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
