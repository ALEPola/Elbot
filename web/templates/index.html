<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELBOT Control Center</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/futuristic.css') }}">
  <!-- If futuristic.css is not loading, double-check the file path and your web server's static file configuration (e.g., in Nginx or Apache). -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="neon">

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand futuristic-heading fs-4" href="/">ELBOT</a>
    <div>
      <a href="/logs" class="btn btn-sm btn-neon mx-1">Logs</a>
      <a href="/analytics" class="btn btn-sm btn-neon mx-1">Analytics</a>
      <a href="/logout" class="btn btn-sm btn-neon mx-1">Logout</a>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-xl my-4">
    <div class="row g-4 justify-content-center">

      <!-- Status + Controls -->
      <div class="col-xxl-10">
        <div class="control-card text-center">
          <h2 class="futuristic-heading">Welcome to ELBOT Control Center</h2>
          <p>Manage your bot and view its status here.</p>
          <div class="d-flex justify-content-center mt-3">
            <a href="/status" class="btn btn-neon btn-neon-primary mx-2">Bot Status</a>
            <a href="/logs" class="btn btn-neon btn-neon-primary mx-2">Logs</a>
            <a href="/commands" class="btn btn-neon btn-neon-primary mx-2">Command Management</a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast zone -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastZone"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  /* ---- THEME ---- */
  const savedTheme = localStorage.getItem('theme') || 'neon';
  document.body.dataset.theme = savedTheme;
  document.getElementById('themeToggle').onclick = () => {
    const t = document.body.dataset.theme === 'neon' ? 'dark' : 'neon';
    document.body.dataset.theme = t; localStorage.setItem('theme', t);
  };

  /* ---- WEBSOCKET LOGS ---- */
  const logBox = document.getElementById('logOutput');
  const ws = new WebSocket(`ws://${location.host}/ws/logs`);
  ws.onmessage = e => { logBox.textContent += e.data + "\\n"; logBox.scrollTop = logBox.scrollHeight; };
  ws.onerror   = () => logBox.textContent += '\\n[log stream error]';

  /* ---- CHART ---- */
  const ctx = document.getElementById('cpuChart');
  const chart = new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:'CPU %',data:[],borderColor:'var(--accent)',tension:.3}]},
    options:{responsive:true,animation:false,scales:{y:{min:0,max:100}}}
  });
  setInterval(async()=>{
    const res=await fetch('/api/system'); if(!res.ok) return;
    const {cpu}=await res.json();
    const t=new Date().toLocaleTimeString();
    chart.data.labels.push(t); chart.data.datasets[0].data.push(cpu);
    if(chart.data.labels.length>60){chart.data.labels.shift();chart.data.datasets[0].data.shift();}
    chart.update();
  },3000);

  /* ---- STATUS BADGE ---- */
  fetch('/api/status').then(r=>r.json()).then(j=>{
    const b=document.getElementById('botStatus');
    b.textContent='Status: '+j.status;
    b.className='status-badge '+(j.status==='Running'?'bg-success':'bg-danger')+' text-white';
  });

  /* ---- COMMAND RUNNER ---- */
  document.getElementById('commandForm').addEventListener('submit',e=>{
    e.preventDefault();
    const cmd=document.getElementById('commandInput').value.trim();
    if(!cmd) return;
    fetch('/run-command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})})
      .then(r=>r.json()).then(j=>document.getElementById('commandOutput').textContent=j.output);
  });

  /* ---- BRANCH LIST & SWITCH ---- */
  fetch('/api/branches').then(r=>r.json()).then(j=>{
    const sel=document.getElementById('branchSelect'); sel.innerHTML='';
    j.branches.forEach(b=>sel.insertAdjacentHTML('beforeend',`<option>${b}</option>`));
  });
  document.getElementById('branchForm').addEventListener('submit',e=>{
    e.preventDefault();
    const branch=document.getElementById('branchSelect').value;
    fetch('/switch-branch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({branch})})
      .then(r=>r.json()).then(j=>{
        document.getElementById('branchOutput').textContent=j.error||j.output;
      });
  });

  /* ---- ENV VARS ---- */
  fetch('/api/env').then(r=>r.json()).then(j=>{
    document.getElementById('envOutput').textContent =
      Object.entries(j).map(([k,v])=>`${k}: ${v}`).join('\\n');
  });

  /* ---- SCHEDULER ---- */
  document.getElementById('scheduleForm').addEventListener('submit',e=>{
    e.preventDefault();
    const t=document.getElementById('scheduleTime').value.trim();
    if(!t) return;
    fetch(`/action/schedule:${t}`).then(()=>{
      document.getElementById('scheduleOutput').textContent=`Restart scheduled for ${t}`;
    });
  });

  /* ---- LAST UPDATE ---- */
  fetch('/api/status')
      .then(response => response.json())
      .then(data => {
          document.getElementById('last-update').textContent = new Date().toLocaleString();
      })
      .catch(error => console.error('Error fetching last update:', error));

  /* ---- THEME SWITCHER ---- */
  const themeSwitcher = document.getElementById('themeSwitcher');
  themeSwitcher.addEventListener('click', () => {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    document.getElementById('themeStylesheet').setAttribute('href', `/static/css/${newTheme}.css`);
  });
</script>

<style>
    .last-update {
        margin-top: 20px;
        font-size: 14px;
        color: #555;
    }
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        .last-update {
            font-size: 12px;
        }
    }
</style>
</body>
</html>
